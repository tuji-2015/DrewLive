name: ğŸ” Update DrewLive EPG ğŸ“º

on:
Â  schedule:
Â  Â  - cron: '0 * * * *'Â 
Â  workflow_dispatch:

permissions:
Â  contents: write

jobs:
Â  update_epg:
Â  Â  runs-on: ubuntu-latest

Â  Â  steps:
Â  Â  Â  - name: ğŸ“¥ Checkout repository
Â  Â  Â  Â  uses: actions/checkout@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  fetch-depth: 0

Â  Â  Â  - name: ğŸ Set up Python 3.11
Â  Â  Â  Â  uses: actions/setup-python@v5
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  python-version: '3.11'

Â  Â  Â  - name: ğŸ“¦ Install dependencies
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  python -m pip install --upgrade pip
Â  Â  Â  Â  Â  pip install requests

Â  Â  Â  - name: ğŸ¯ Run DrewLive EPG merger
Â  Â  Â  Â  run: python drewepg.py

Â  Â  Â  - name: ğŸ’¾ Commit & Push if EPG Changed
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  git config user.name "github-actions[bot]"
Â  Â  Â  Â  Â  git config user.email "github-actions[bot]@users.noreply.github.com"

Â  Â  Â  Â  Â  # --- Matches your Python script output ---
Â  Â  Â  Â  Â  git add DrewLive.xml.gz

Â  Â  Â  Â  Â  if git diff --cached --quiet; then
Â  Â  Â  Â  Â  Â  echo "âœ… No changes detected â€” skipping commit."
Â  Â  Â  Â  Â  Â  exit 0
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  git commit -m "ğŸ” Auto-update DrewLive EPG ($(date -u +'%Y-%m-%d %H:%M UTC'))"

Â  Â  Â  Â  Â  # Random delay to reduce push collisions
Â  Â  Â  Â  Â  sleep $((RANDOM % 10 + 5))

Â  Â  Â  Â  Â  if ! git push origin main; then
Â  Â  Â  Â  Â  Â  echo "âš ï¸ Push failed, attempting safe rebase..."
Â  Â  Â  Â  Â  Â  git pull origin main --rebase || {
Â  Â  Â  Â  Â  Â  Â  echo "âŒ Rebase failed. Stopping to avoid corruption."
Â  Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  git push origin main || {
Â  Â  Â  Â  Â  Â  Â  echo "âŒ Push failed again after rebase."
Â  Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  fi
